# Morten 2025 - Codebase Guide

Personal portfolio website for Patryk Smakosz built with Nuxt 4, featuring directive-based GSAP page transitions and ScrollSmoother integration.

## Common Commands

### Development
```bash
# Start dev server with SCSS watch (http://localhost:3000)
npm run dev

# Build SCSS only (run manually if needed)
npm run styles:build

# Watch SCSS changes (already included in npm run dev)
npm run styles:watch
```

### Production
```bash
# Build for production (automatically runs styles:build first)
npm run build

# Preview production build locally
npm run preview

# Generate static site
npm run generate
```

### Dependencies
```bash
# Install all dependencies
npm install

# Postinstall automatically runs nuxt prepare
```

## High-Level Architecture

### Stack Overview
- **Framework**: Nuxt 4 (Vue 3) with Composition API
- **Styling**: TailwindCSS v4 via Vite + SCSS preprocessing
- **Animation**: GSAP with premium Club GreenSock plugins (FREE as of 2025)
- **Type Safety**: JSDoc type annotations (NO TypeScript)
- **State Management**: Pinia + Vue composables
- **Content**: Nuxt Content module

### Core Technologies

#### GSAP Integration (@hypernym/nuxt-gsap)
Premium plugins enabled via Club GreenSock (free since 2025):
- **MorphSVG** - Morph between SVG shapes
- **DrawSVG** - Animate SVG stroke drawing
- **SplitText** - Split text into animatable chars/words/lines
- **ScrollSmoother** - Smooth scrolling with parallax effects
- **CustomBounce/CustomWiggle** - Advanced easing curves
- **GSDevTools** - Timeline debugging in development

Extra plugins:
- **ScrollTrigger** - Scroll-based animations (required for ScrollSmoother)
- **Observer** - Mutation and resize observers
- **Flip** - First Last Invert Play technique
- **MotionPath** - Animate along SVG paths

#### CSS Architecture (Three-Layer System)
```
pre.scss ‚Üí Tailwind ‚Üí post.scss
```

1. **pre.scss** - Loads BEFORE Tailwind
   - CSS custom properties (design tokens)
   - Base styles, resets
   - Early utilities that Tailwind should see

2. **Tailwind** - Generated by TailwindCSS v4
   - Utility classes
   - Responsive variants
   - Component layer

3. **post.scss** - Loads AFTER Tailwind
   - Complex components needing Tailwind classes
   - Layout-specific styles
   - Overrides and refinements

**Critical**: Keep `main.css` as CSS file (not SCSS) for TailwindCSS v4 compatibility.

### Page Transition System

**Philosophy**: Directive-based manual control - NO auto-detection.

#### How It Works
```vue
<!-- Mark elements explicitly with directives -->
<h1 v-page-split:chars data-speed="0.7">Animated Title</h1>
<p v-page-fade:up data-lag="0.15">Fades up with lag</p>
```

**Lifecycle**:
1. **Directives Store Config** - When mounted, directives attach animation config to `element._pageAnimation`
2. **Page Leaves** - `usePageTransition` finds marked elements and animates them OUT
3. **DOM Swap** - Vue swaps old page for new page
4. **Page Enters** - New page elements animate IN with opposite animations
5. **ScrollSmoother Refresh** - Parallax effects recalculate for new content

#### Available Directives
- **v-page-split** - SplitText animations (chars/words/lines)
- **v-page-fade** - Fade with directional movement (up/down/left/right)
- **v-page-clip** - Modern clip-path reveals
- **v-page-stagger** - Stagger child elements

#### ScrollSmoother Parallax
Add to any element for smooth parallax effects:
- **data-speed** - Controls movement speed relative to scroll (0.5 = slower, 1.5 = faster)
- **data-lag** - Creates "catch up" effect with momentum (0.1 to 0.3 typical)

#### Safari Height Lock Fix
**Problem**: On Safari, SplitText with masking adds ~7px to element height, causing visible layout jump.

**Solution**: Lock element height BEFORE SplitText runs in `usePageTransition.js`:
```javascript
// In animateSplit() function
const originalHeight = el.offsetHeight
gsap.set(el, { height: originalHeight })

// Now create split - can't grow because height is locked
const split = SplitText.create(el, { type: splitType, mask: splitType })
```

The locked height is automatically cleared in `afterLeave()` with `clearProps: 'all'`.

See `.claude/PAGE_TRANSITIONS.md` for comprehensive transition documentation.

### File Structure

```
app/
‚îú‚îÄ‚îÄ assets/
‚îÇ   ‚îî‚îÄ‚îÄ css/
‚îÇ       ‚îú‚îÄ‚îÄ main.css          # CSS orchestrator (pre ‚Üí Tailwind ‚Üí post)
‚îÇ       ‚îú‚îÄ‚îÄ pre.scss          # Tokens, base (BEFORE Tailwind)
‚îÇ       ‚îî‚îÄ‚îÄ post.scss         # Components (AFTER Tailwind)
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ HeaderGrid.vue        # Fixed header with mobile overlay
‚îÇ   ‚îú‚îÄ‚îÄ SVG/                  # SVG icon components
‚îÇ   ‚îî‚îÄ‚îÄ ThemeToggleSVG.vue    # Theme switcher
‚îú‚îÄ‚îÄ composables/
‚îÇ   ‚îú‚îÄ‚îÄ usePageTransition.js           # Page transition logic
‚îÇ   ‚îú‚îÄ‚îÄ useScrollSmootherManager.js    # ScrollSmoother lifecycle
‚îÇ   ‚îú‚îÄ‚îÄ useThemeSwitch.js              # Dark/light theme
‚îÇ   ‚îî‚îÄ‚îÄ useIsMobile.js                 # Mobile detection
‚îú‚îÄ‚îÄ directives/
‚îÇ   ‚îú‚îÄ‚îÄ v-page-split.js       # SplitText animations
‚îÇ   ‚îú‚îÄ‚îÄ v-page-fade.js        # Fade animations
‚îÇ   ‚îú‚îÄ‚îÄ v-page-clip.js        # Clip-path reveals
‚îÇ   ‚îî‚îÄ‚îÄ v-page-stagger.js     # Stagger children
‚îú‚îÄ‚îÄ layouts/
‚îÇ   ‚îî‚îÄ‚îÄ default.vue           # ScrollSmoother wrapper + page transitions
‚îú‚îÄ‚îÄ pages/
‚îÇ   ‚îú‚îÄ‚îÄ index.vue             # Home page (reference implementation)
‚îÇ   ‚îú‚îÄ‚îÄ about.vue             # About page (reference implementation)
‚îÇ   ‚îî‚îÄ‚îÄ contact.vue           # Contact page (reference implementation)
‚îî‚îÄ‚îÄ plugins/
    ‚îú‚îÄ‚îÄ page-transitions.js   # Register directives globally
    ‚îî‚îÄ‚îÄ headroom.client.js    # Header show/hide behavior

nuxt.config.ts                # Nuxt configuration
tailwind.config.js            # TailwindCSS v4 config
```

## Key Concepts

### Module-Level State for ScrollSmoother
The `useScrollSmootherManager.js` composable uses module-level state to share a single ScrollSmoother instance across all components:

```javascript
let smootherInstance = null // Module-level, persists across calls

export const useScrollSmootherManager = () => {
  const createSmoother = (options) => {
    smootherInstance = ScrollSmoother.create(options)
  }

  const killSmoother = () => {
    if (smootherInstance) {
      smootherInstance.kill()
      smootherInstance = null
    }
  }

  const refreshSmoother = () => {
    if (smootherInstance) {
      smootherInstance.effects('[data-speed], [data-lag]') // Recalculate parallax
      smootherInstance.refresh()
    }
  }

  return { createSmoother, killSmoother, refreshSmoother }
}
```

This pattern ensures:
- Single source of truth for ScrollSmoother instance
- Proper cleanup without stale references
- Composables can refresh without circular dependencies

### Directive Config Storage Pattern
Directives store animation configuration directly on DOM elements using `element._pageAnimation`:

```javascript
// In v-page-fade.js directive
export default {
  mounted(el, binding) {
    const direction = binding.arg || 'up'
    const config = binding.value || {}

    // Store config on element for usePageTransition to read
    el._pageAnimation = {
      type: 'fade',
      config: {
        direction,
        distance: config.distance || 20,
        duration: config.duration || 0.6,
        ease: config.ease || 'power2.out'
      }
    }
  },

  getSSRProps() {
    return {} // SSR-compatible
  }
}
```

This pattern:
- Keeps directive logic simple (just store config)
- Composable reads config and creates animations
- SSR-compatible (no DOM manipulation during SSR)
- Clean separation of concerns

### Layout Structure for ScrollSmoother
ScrollSmoother requires specific DOM structure:

```vue
<!-- app/layouts/default.vue -->
<div id="smooth-wrapper">
  <HeaderGrid />  <!-- Fixed header OUTSIDE smooth-content -->

  <div id="smooth-content">
    <div class="layout-wrapper">
      <NuxtPage :transition="{ ... }" />
    </div>
  </div>
</div>
```

**Why this structure**:
- HeaderGrid is positioned fixed, outside smooth-content
- smooth-content is the scrollable container
- ScrollSmoother transforms smooth-content for smooth scrolling
- Page transitions happen inside layout-wrapper

## Development Notes

### Running Dev Server
- Dev server runs on `http://localhost:3000`
- SCSS watch is automatically included in `npm run dev`
- Changes to SCSS files trigger automatic rebuild
- Changes to Vue files trigger hot module replacement

### SCSS Compilation
SCSS files are compiled to CSS using Sass CLI:
- `pre.scss` ‚Üí `pre.css`
- `post.scss` ‚Üí `post.css`
- Both are imported in `main.css`
- Watch mode runs in parallel with Nuxt dev server

### GSAP Premium Plugins
All Club GreenSock plugins are FREE as of 2025:
- No license key needed
- Available via `@hypernym/nuxt-gsap` module
- Auto-injected as Nuxt composables (`$gsap`, `$ScrollTrigger`, etc.)
- Access in components via `useNuxtApp()`:
  ```javascript
  const { $gsap, $ScrollTrigger, $SplitText } = useNuxtApp()
  ```

### Page Structure Requirements
All pages must wrap content in `.page-content` for transitions:

```vue
<template>
  <div class="page-content">
    <!-- Directive-marked elements here -->
    <h1 v-page-split:chars data-speed="0.7">Title</h1>
    <p v-page-fade:up data-lag="0.15">Content</p>
  </div>
</template>
```

### Debugging Page Transitions
Watch console logs during navigation:
```
üöÄ Page LEAVE
üîç Finding animated elements in: <div class="page-content">
üîç Found elements with directives: 5
üé¨ Page ENTER
üîç Finding animated elements in: <div class="page-content">
üîç Found elements with directives: 6
üîÑ ScrollSmoother effects recalculated
üîÑ ScrollSmoother refreshed
```

Missing logs indicate:
- Directives not registered (check `plugins/page-transitions.js`)
- Wrong page structure (missing `.page-content`)
- ScrollSmoother not initialized (check layout)

### Common Issues

| Symptom | Cause | Solution |
|---------|-------|----------|
| Animations not running | Directives not registered | Check `plugins/page-transitions.js` loads |
| Elements jump during transition | ScrollSmoother not refreshed | Verify `refreshSmoother()` called in enter() |
| SplitText not working | Plugin not enabled | Enable `splitText: true` in nuxt.config |
| No parallax effects | effects: false | Set `effects: true` in createSmoother() |
| Duplicated imports warning | Naming conflict | Use distinct names (e.g., `useScrollSmootherManager`) |

## Reference Implementation

This page transition system is based on the working [nuxt4page-transitions](https://github.com/user/nuxt4page-transitions) demo.

Key files adapted from reference:
- `app/composables/usePageTransition.js`
- `app/composables/useScrollSmootherManager.js`
- `app/directives/*.js`
- `app/plugins/page-transitions.js`
- `app/layouts/default.vue`
- `app/pages/index.vue`, `about.vue`, `contact.vue`

All implementations follow the reference patterns for:
- Directive-based manual control
- Safari height lock fix for SplitText
- Module-level state management
- Simple enter() timing (no pre-setting states)
- ScrollSmoother lifecycle

For detailed transition documentation, see `.claude/PAGE_TRANSITIONS.md`.
